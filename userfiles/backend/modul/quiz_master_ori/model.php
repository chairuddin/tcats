<?php/*Catatan pakai yona-validation:Form :	Form menggunakan class yona-validation	Tombol submit name=submitVar  : nama element harus sama dengan var   * */$hari_ini=date("Y-m-d H:i:s");$admin_id=$_SESSION['s_id'];//$validation->set_validation(array('var'=>'grade','label'=>'Grade'))->required();$validation->set_validation(array('var'=>'code','label'=>'Kode Soal'))->minlength(3)->required();$validation->set_validation(array('var'=>'title_id','label'=>'Nama Soal'))->minlength(2)->required();$validation->set_validation(array('var'=>'duration','label'=>'Durasi'))->min(1)->required();$validation->set_validation(array('var'=>'score','label'=>'Skor (maksimal)'))->min(1)->required();$validation->set_validation(array('var'=>'score_essay','label'=>'Skor (maksimal)'))->min(1)->required();$validation->set_validation(array('var'=>'kkm','label'=>'Durasi'))->min(1)->required();$validation->set_validation(array('var'=>'is_random','label'=>'Acak Soal'))->required();$validation->set_validation(array('var'=>'is_random_option','label'=>'Acak Pilihan Jawaban'))->required();$validation->generate_js_validation();if($action=="save" or $action=="update") {	$valid=true;	$id=$_POST['id'];	$code=$_POST['code'];	$custom_score=0;	if($action=="save"){		$is_duplicate=$mysql->get1value("SELECT count(id) FROM quiz_master WHERE code='$code' ");	}		if($action=="update") {		$is_duplicate=$mysql->get1value("SELECT count(id) FROM quiz_master WHERE code='$code' AND id<>$id ");	}		if($is_duplicate) {		$validation->set_validation(array('var'=>'code','label'=>'Kode Soal'))->custom_msg($is_duplicate,"Kode Soal harus unik");	}		if($validation->valid()){		$r_post=array(		'grade',		'code',		'title_id',		'duration',		'score',		'score_essay',		'kkm',		'is_random',		'is_random_option',		'custom_score'		);						$sql_r = array();				foreach($pilihan_ganda as $pil_gan) {			$sql_r[]="poin_$pil_gan='".$_POST["poin_$pil_gan"]."'";		}				if($action=="save") {			$sql_r[]="created_by='$admin_id'";			$sql_r[]="created_date='$hari_ini'";		}				if($action=="update") {			$sql_r[]="modified_by='$admin_id'";			$sql_r[]="modified_date='$hari_ini'";		}						foreach($r_post as $i => $v) {			$post=cleanInput($_POST[$v]);			$sql_r[]="$v = '$post'";		}				if($action=="save") {			$sql=" INSERT INTO quiz_master SET ".join(" ,",$sql_r);			$q=$mysql->query($sql);			if(!$q) {				$valid=false;			}			$last_id=$mysql->insert_id();		}				if($action=="update") {			$sql=" UPDATE quiz_master SET ".join(" ,",$sql_r)." WHERE id=$id ";			$q=$mysql->query($sql);			if(!$q) {				$valid=false;			}		}				} else {		sweetalert2($type="warning",$msg=($action=="update"?"Update":"Tambah")." Master Soal gagal, data tidak valid",backendurl("$modul".($action=="update"?"/edit/$id":"/add")));	}		if($valid){		sweetalert2($type="success",$msg=($action=="update"?"Update":"Tambah")." Master Soal berhasil",backendurl("$modul"));	} else {		sweetalert2($type="warning",$msg=($action=="update"?"Update":"Tambah")." Master Soal gagal. ",backendurl("$modul".($action=="update"?"/edit/$id":"/add")));	}	}if($action=="del"){	$valid=true;	$mysql->autocommit(false);		$id=cleanInput($id,'numeric');	$folder_guru=$mysql->get1value("SELECT username FROM user WHERE id IN(SELECT created_by FROM quiz_master WHERE id='".$id."')");		$folder_soal=$folder_guru."/dir_".$id;	remove_soal_json($id);	$sql="DELETE FROM quiz_master WHERE id='$id'";	$r=$mysql->query($sql);	if(!$r){$valid=false;}	$sql="DELETE FROM quiz_detail WHERE quiz_id='$id'";	$r=$mysql->query($sql);	if(!$r){$valid=false;}	$sql="DELETE FROM quiz_essay WHERE quiz_id='$id'";	$r=$mysql->query($sql);	if(!$r){$valid=false;$option_msg=", Soal essay sudah digunakan untuk ujian. tidak bisa dihapus! ";}	//update log	if($valid) 	{				if($folder_guru!="" and $id!="")		{			if(file_exists(DIR_IMAGES."/source/$folder_guru")){				if(file_exists(DIR_IMAGES."/source/$folder_soal")){					delete_files(DIR_IMAGES."/source/$folder_soal");				}						}		}	}		if($valid){		$mysql->commit();		$mysql->autocommit(true);		sweetalert2($type="success",$msg="Hapus soal berhasil",backendurl("$modul"));	} else {		$mysql->rollback();			sweetalert2($type="warning",$msg="Hapus soal gagal $option_msg",backendurl("$modul"));	}	}?>