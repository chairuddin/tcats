<?phpif($action=="uploadwordx" AND Form::isValid("uploadwordx",false) and $_POST['form']=='uploadwordx'){ 	$destination=$config['userdir'].'backend/modul/quiz_upload_wordx/backup/'.$_FILES['file_wordx']['name'];	$filename=$_FILES['file_wordx']['name'];	if (!move_uploaded_file($_FILES['file_wordx']['tmp_name'], $destination)) {		return _MAYBEPERMISSION;	}else{	$action="view_soal";	}}if($action=="approve"){		$id_soal=$_POST['id_soal'];	$file_wordx=$_POST['file_wordx'];	$document=$config['userdir'].'backend/modul/quiz_upload_wordx/backup/'.$file_wordx;		$kode_soal=$mysql->get1value("SELECT code FROM quiz_master WHERE id='".$id_soal."'");		$htmlname="Template_Soal_".$kode_soal.'.htm';	$folder_soal=$_POST['id_soal'];		$folder_guru=$mysql->get1value("SELECT username FROM user WHERE id IN(SELECT created_by FROM quiz_master WHERE id='".$id_soal."')");	$directory_soal_1="/".$folder_guru."/dir_".$folder_soal;	$directory_soal_2=$folder_guru."/dir_".$folder_soal."/";	$upload_dir =($config['subdir']!=""?"/".$config['subdir']:"")."/userfiles/file/".$_d['dir']."/media/source/$directory_soal_2"; // path from base_url to base of upload folder (with start and final /)		if(!file_exists(DIR_IMAGES))	{		mkdir(DIR_IMAGES,0777);	}	else	{	//dir(DIR_IMAGES);	}			if(file_exists(DIR_IMAGES."/source/$folder_guru")==false){	mkdir(DIR_IMAGES."/source/$folder_guru",0755);	}	if(file_exists(DIR_IMAGES."/thumbs/$folder_guru")==false){	mkdir(DIR_IMAGES."/thumbs/$folder_guru",0755);	}		if(file_exists(DIR_IMAGES."/source$directory_soal_1")==false){	mkdir(DIR_IMAGES."/source$directory_soal_1",0755);	}	if(file_exists(DIR_IMAGES."/thumbs$directory_soal_1")==false){	mkdir(DIR_IMAGES."/thumbs$directory_soal_1",0755);	}					////////////////$array_images=array();///////////////$zip = new ZipArchive;$zip->open($document);for( $i = 0; $i < $zip->numFiles; $i++ ){     $stat = $zip->statIndex( $i );     $zipfilename = basename($stat['name']);	$ext = pathinfo($zipfilename, PATHINFO_EXTENSION);		if($ext=="htm"){		$htmlname=$zipfilename;	}else{		continue;	}	}//cek gambar /*Open the received archive file*/	if (true === $zip->open($document)) {		for ($i=0; $i<$zip->numFiles;$i++) {		/*Loop via all the files to check for image files*/		 $zip_element = $zip->statIndex($i);			/*Check for images*/			if(preg_match("([^\s]+(\.(?i)(jpg|jpeg|png|gif|bmp))$)",$zip_element['name'])) {			$file = basename($zip_element['name']); 				$array_images[$file]=$i;			/*Display images if present by using display.php*/			//echo $zip_element['name']."<br/>";			//echo "<img src='display.php?filename=".$filename."&index=".$i."' /><hr />";			}		}	}//end cek gambar$pertanyaan=array();$essay=array();/**/if (($index = $zip->locateName($htmlname)) !== false) {    $text = $zip->getFromIndex($index);	$xml= new DOMDocument(); 	$xml->preserveWhiteSpace=false;	$xml->formatOutput= true;	$xml->loadHTML($text); 	    //$table=$xml->getElementsByTagName('table');	$r_pertanyaan=array();	$r_essay=array();	$xpath = new DOMXPath($xml);	foreach ($xpath->query('//body/div/table') as $table) {		// in case you really wanted them...		$superCol = $table->parentNode;		$superRow = $superCol->parentNode;				$imgs=$table->getElementsByTagName('img');		foreach ($imgs as $i => $img) 		{			$src = $img->getAttribute('src');			$file = basename($src); 			$index=$array_images[$file];			//$img->setAttribute('src','/userfiles/file/quiz/media/source/'.$file);			//die("$upload_dir{$file}");			$uniqid=uniqid();			$img->setAttribute('src',"$upload_dir{$uniqid}{$file}");			$src = $img->getAttribute('src');			/* upload image */			$url_image=backendurl("images/display.php?filename=".urlencode($file_wordx)."&index=".$index);						$image = file_get_contents($url_image);						//die(DIR_IMAGES."/source/$directory_soal_2{$file}");			//die(DIR_IMAGES."/source/$directory_soal_2{$uniqid}{$file}");			file_put_contents(DIR_IMAGES."/source/$directory_soal_2{$uniqid}{$file}",$image); 			//die(DIR_IMAGES."/source/$directory_soal_2"."a"."{$uniqid}{$file}");			//Where to save the image on your server			/* end upload image */			//echo $src;			//echo "<br/>";		}		foreach ($table->childNodes as $row) {			$column=$row->childNodes;					$nomor=$column->item(0)->nodeValue;			$tanya=$column->item(2);			$tanya_table=$tanya->childNodes->item(1);			$tanya_table_row=$tanya_table->childNodes->item(0);			$tanya_table_td=$tanya_table_row->childNodes;						//extract tabel pertanyaan			$label_tanya=$tanya_table_td->item(0)->nodeValue;			$isi_tanya=$tanya_table_td->item(2);						//extract tabel essay			if(trim($label_tanya)=="ESSAY"){								$isi=$isi_tanya->childNodes;				if(count($isi)>0){					foreach ($isi as $cell){											$string = $cell->C14N();						$string = upload_wordx_cleaner($string);						if(strlen($string)>0){							$r_essay[$nomor]['question'].=$string;						}					}				}			}									if(trim($label_tanya)=="PERTANYAAN"){				$isi=$isi_tanya->childNodes;				foreach ($isi as $cell){					//$r_pertanyaan[$nomor]['question'].=$cell->C14N();						$string = $cell->C14N();					$r_pertanyaan[$nomor]['question'].=upload_wordx_cleaner($string);				}				// $isi=$isi_tanya->childNodes->item(1);				// $isi->removeAttribute("style");				// $isi->removeAttribute("class");								// $r_pertanyaan[$nomor]['question']=$isi->C14N();							}			//extract A			$tanya_table_row=$tanya_table->childNodes->item(1);			$tanya_table_td=$tanya_table_row->childNodes;				if($tanya_table_td!= NULL){				$label_tanya=$tanya_table_td->item(0)->nodeValue;				$isi_tanya=$tanya_table_td->item(2);				if(trim($label_tanya)=="A"){					$isi=$isi_tanya->childNodes;					foreach ($isi as $cell){						$string = $cell->C14N();						$r_pertanyaan[$nomor]['A'].=upload_wordx_cleaner($string);								}					/*					$isi=$isi_tanya->childNodes->item(1);					if($isi){					$isi->removeAttribute("style");					$isi->removeAttribute("class");					$r_pertanyaan[$nomor]['A']=$isi->C14N();					}else{					$r_pertanyaan[$nomor]['A']="";						}					*/				}			}			//extract B			$tanya_table_row=$tanya_table->childNodes->item(2);			$tanya_table_td=$tanya_table_row->childNodes;			if($tanya_table_td!= NULL){			$label_tanya=$tanya_table_td->item(0)->nodeValue;			$isi_tanya=$tanya_table_td->item(2);			if(trim($label_tanya)=="B"){				$isi=$isi_tanya->childNodes;				foreach ($isi as $cell){					$string = $cell->C14N();					$r_pertanyaan[$nomor]['B'].=upload_wordx_cleaner($string);							}				/*				$isi=$isi_tanya->childNodes->item(1);				if($isi){				$isi->removeAttribute("style");				$isi->removeAttribute("class");				$r_pertanyaan[$nomor]['B']=$isi->C14N();				}else{				$r_pertanyaan[$nomor]['B']="";					}				*/			}			}			//extract C			$tanya_table_row=$tanya_table->childNodes->item(3);			$tanya_table_td=$tanya_table_row->childNodes;			if($tanya_table_td!= NULL){			$label_tanya=$tanya_table_td->item(0)->nodeValue;			$isi_tanya=$tanya_table_td->item(2);			if(trim($label_tanya)=="C"){				$isi=$isi_tanya->childNodes;				foreach ($isi as $cell){					$string = $cell->C14N();					$r_pertanyaan[$nomor]['C'].=upload_wordx_cleaner($string);				}				/*				$isi=$isi_tanya->childNodes->item(1);				if($isi){				$isi->removeAttribute("style");				$isi->removeAttribute("class");				$r_pertanyaan[$nomor]['C']=$isi->C14N();				}else{				$r_pertanyaan[$nomor]['C']="";					}				*/			}			}			//extract D			$tanya_table_row=$tanya_table->childNodes->item(4);			$tanya_table_td=$tanya_table_row->childNodes;			if($tanya_table_td!= NULL){			$label_tanya=$tanya_table_td->item(0)->nodeValue;			$isi_tanya=$tanya_table_td->item(2);			if(trim($label_tanya)=="D"){				$isi=$isi_tanya->childNodes;				foreach ($isi as $cell){					$string = $cell->C14N();					$r_pertanyaan[$nomor]['D'].=upload_wordx_cleaner($string);								}				/*				$isi=$isi_tanya->childNodes->item(1);				if($isi){				$isi->removeAttribute("style");				$isi->removeAttribute("class");				$r_pertanyaan[$nomor]['D']=$isi->C14N();				}else{				$r_pertanyaan[$nomor]['D']="";					}				*/			}			}			//extract E			$tanya_table_row=$tanya_table->childNodes->item(5);			$tanya_table_td=$tanya_table_row->childNodes;			if($tanya_table_td!= NULL){			$label_tanya=$tanya_table_td->item(0)->nodeValue;			$isi_tanya=$tanya_table_td->item(2);			if(trim($label_tanya)=="E"){				$isi=$isi_tanya->childNodes;				foreach ($isi as $cell){					$string = $cell->C14N();					$r_pertanyaan[$nomor]['E'].=upload_wordx_cleaner($string);								}				/*				$isi=$isi_tanya->childNodes->item(1);				if($isi){				$isi->removeAttribute("style");				$isi->removeAttribute("class");				$r_pertanyaan[$nomor]['E']=$isi->C14N();				}else{				$r_pertanyaan[$nomor]['E']="";					}				*/							}			}			//extract KUNCI			$tanya_table_row=$tanya_table->childNodes->item(6);			$tanya_table_td=$tanya_table_row->childNodes;			if($tanya_table_td!= NULL){			$label_tanya=$tanya_table_td->item(0)->nodeValue;			$isi_tanya=$tanya_table_td->item(2);			if(trim($label_tanya)=="KUNCI"){				$isi=$isi_tanya->childNodes->item(1);				$r_pertanyaan[$nomor]['answer']=strtoupper(upload_wordx_trimmer($isi->nodeValue));			}			}				}			}}	if(count($r_pertanyaan)>0)	{			$valid=true;				if($_POST['timpa']==1){		$timpa_soal=$mysql->query("DELETE FROM quiz_detail WHERE quiz_id='$id_soal'");		}		foreach($r_pertanyaan as $nomor => $d)		{		${"model"}=1;		if($A=="-" AND $B=="-" AND $B=="-" AND $D=="-" AND $E=="-"){		${"model"}=0;			}				${"A"}=addslashes($d["A"]);		${"B"}=addslashes($d["B"]);		${"C"}=addslashes($d["C"]);		${"D"}=addslashes($d["D"]);		${"E"}=addslashes($d["E"]);		${"answer"}=addslashes($d["answer"]);		${"question"}=addslashes($d["question"]);						${"id_soal"}=cleanInput($id_soal);								$sql_r=array();		$sql="		INSERT INTO quiz_detail SET ";				$sql_r[]="question='".${"question"}."'";			$sql_r[]="A='".${"A"}."'";			$sql_r[]="B='".${"B"}."'";			$sql_r[]="C='".${"C"}."'";			$sql_r[]="D='".${"D"}."'";			$sql_r[]="E='".${"E"}."'";			$sql_r[]="answer='".${"answer"}."'";			$sql_r[]="model='".${"model"}."'";			$sql_r[]="quiz_id='".${"id_soal"}."'";			$sql.=join(",",$sql_r);		$sukses=$r=$mysql->query($sql);		if(!$sukses){		$r=$mysql->query($sql);		$valid=false;		}				}				}		if(count($r_essay)>0 and $valid)	{					if($_POST['timpa']==1){		$timpa_soal=$mysql->query("DELETE FROM quiz_essay WHERE quiz_id='$id_soal'");		}		foreach($r_essay as $nomor => $d)		{		${"question"}=addslashes($d["question"]);		${"id_soal"}=cleanInput($id_soal);					$sql_r=array();		$sql="		INSERT INTO quiz_essay SET ";		$sql_r[]="question='".${"question"}."'";			$sql_r[]="quiz_id='".${"id_soal"}."'";			$sql.=join(",",$sql_r);		$sukses=$r=$mysql->query($sql);		if(!$sukses){		$r=$mysql->query($sql);		$valid=false;		}		}		}		if($valid){	msg_warning("Soal berhasil dimasukkan kedalam database","success");	unlink($document);	header('Cache-Control: no-cache');	header('Pragma: no-cache');	header("location:".backendurl("quiz_detail/view/?id_soal=$id_soal"));	exit();		}	else{	msg_warning("Soal gagal dimasukkan kedalam database","success");	unlink($document);	header('Cache-Control: no-cache');	header('Pragma: no-cache');	header("location:".backendurl("quiz_detail/view/?id_soal=$id_soal"));		}}?>