<?php// for($i=1;$i<500;$i++)// {// $sql="INSERT INTO `member` (`email`, `fullname`, `hp`, `alamat`, `password`, `authcode`, `status`, `regdate`, `level`) VALUES// ('roemly@a$i,com', 'ciamik', '12312', 'slkjfslj', '', '', 0, '2014-05-01 22:25:18', 0)";// $r=$mysql->query($sql);// }if($action=="download"){	include ("mysql_backup.php");		$backup_obj = new MySQL_Backup();	$backup_obj->server = $host[$_SERVER['HTTP_HOST']]['db_host'];	$backup_obj->username = $host[$_SERVER['HTTP_HOST']]['db_user'];	$backup_obj->password = $host[$_SERVER['HTTP_HOST']]['db_pass'];	$backup_obj->database = $host[$_SERVER['HTTP_HOST']]['db_name'];		if (!$backup_obj->_Connect())	{	$sukses=false;	$msg_status=alert(_ERROR,'Gagal konek');	}	mysqli_autocommit($backup_obj->link_id,false);		$backup_obj->queries['quiz_member']="select * from quiz_member ";	$backup_obj->comments = false;				//Directory on the server where the backup file will be placed. Used only if task parameter equals MSB_SAVE.		$backup_obj->backup_dir = $config['userdir'].'backend/modul/quiz_member/backup';					//Default file name format.		$backup_obj->fname_format = 'd_m_Y';	//--------------------- END - OPTIONAL PREFERENCE VARIABLES ---------------------		//Use GZip compression 		$backup_obj->use_gzip = true;		$backup_obj->stand_in_view = false;			//--------------------- END - REQUIRED EXECUTE VARIABLES ----------------------	  $filename="MASTER_PESERTA_QUIZROOM_".date("Ymd-His");	  $backup_obj->nama_simpan =$filename;	  $backup_obj->Execute($filename);	  $backup_obj->Download();	}if($action=="uploadmember_xls"){		$is_replace=cleanInput($_POST['replace']);	if($is_replace){	$q=$mysql->query("DELETE FROM quiz_member");	if(!$q){$gagal=true;}	}	$destination=filepath("user/".$_FILES['filename']['name']);	$filename=$_FILES['filename']['name'];	if (!move_uploaded_file($_FILES['filename']['tmp_name'], $destination)) {		return _MAYBEPERMISSION;	}else{		$alamat=filepath("user/$filename");	$objPHPExcel = PHPExcel_IOFactory::load($alamat);			$dataArr = array();	 	foreach ($objPHPExcel->getWorksheetIterator() as $worksheet) {		$worksheetTitle     = $worksheet->getTitle();		$highestRow         = $worksheet->getHighestRow(); // e.g. 10		$highestColumn      = $worksheet->getHighestColumn(); // e.g 'F'		$highestColumnIndex = PHPExcel_Cell::columnIndexFromString($highestColumn);		 		for ($row = 1; $row <= $highestRow; ++ $row) {			for ($col = 0; $col < $highestColumnIndex; ++ $col) {				$cell = $worksheet->getCellByColumnAndRow($col, $row);				$val = $cell->getValue();				$dataArr[$row][$col] = $val;			}		}	}	unset($dataArr[1]);	$already_exist=array();	$success_input=array();	foreach($dataArr as $val){		$q=$mysql->query("INSERT INTO quiz_member set username='".cleanInput($val[0])."',fullname='".cleanInput($val[1])."',class='".cleanInput($val[2])."',status=1");		reset_member(cleanInput($val[0]));		if($q){			$success_input[]=cleanInput($val[1]);		}else{			$already_exist[]=cleanInput($val[1]);		}    }		if(count($already_exist)>0){		$join_msg="";		if(count($success_input)>0){		if(count($success_input)>10){			$join_msg="			Sukses menambahkan user:<br/>			<ul><li>".count($success_input)." Peserta</li></ul><br/>";				}else{			$join_msg="			Sukses menambahkan user:<br/>			<ul><li>".join("</li><li>",$success_input)."</li></ul><br/>";			}				}		if(count($already_exist)>10){			$join_error="<ul><li>".count($already_exist)." Peserta</li></ul>";				}else{			$join_error="<ul><li>".join("</li><li>",$already_exist)."</li></ul>";			}				redirecto("{$join_msg}Gagal tambah user berikut karena username sudah terdaftar:<br/>$join_error","error","view");	}	else	{		if(count($success_input)>10){			$join_msg="<ul><li>".count($success_input)." Peserta</li></ul>";				}else{			$join_msg="<ul><li>".join("</li><li>",$success_input)."</li></ul>";			}		redirecto("Sukses menambahkan user:<br/>$join_msg","success","view");		}		}		}if($action=="upload"){		$fname=$_FILES['filename']['tmp_name'];		$oname=$_FILES['filename']['name'];				include_once ("mysql_backup.php");		//----------------------- EDIT - REQUIRED SETUP VARIABLES -----------------------		$backup_obj = new MySQL_Backup();		$backup_obj->server = $host[$_SERVER['HTTP_HOST']]['db_host'];		$backup_obj->username = $host[$_SERVER['HTTP_HOST']]['db_user'];		$backup_obj->password = $host[$_SERVER['HTTP_HOST']]['db_pass'];		$backup_obj->database = $host[$_SERVER['HTTP_HOST']]['db_name'];		//------------------------ END - REQUIRED SETUP VARIABLES -----------------------		$backup_obj->Restore($fname);		$sukses=$backup_obj->status_commit;				if($sukses)		{				unlink($fname);			msg_warning("Member berhasil diupload","success");			header("location:".backendurl("$modul/view"));			exit();		}		else		{			msg_warning($backup_obj->message,"error");			header("location:".backendurl("$modul/view"));			exit();		}		}if($action=="uploadmember"){$gagal=false; $error_sql=_GAGALUPLOADMEMBER;   if ($_FILES["member_csv"]["size"] > 0) {$mysql->autocommit(false);$is_replace=cleanInput($_POST['replace']);if($is_replace){$q=$mysql->query("DELETE FROM quiz_member");if(!$q){$gagal=true;}}    //get the csv file    $file = $_FILES["member_csv"]["tmp_name"];    $handle = fopen($file,"r");    //loop through the csv file and insert into database    $skip=1;    while ($data = fgetcsv($handle,1000,",","'")){					        if ($skip>1) {						$insert=$mysql->query("INSERT INTO quiz_member (username, fullname, class,lastmodify) VALUES                (                    '".addslashes(trim($data[0]))."',                    '".addslashes(str_replace('"','',$data[1]))."',                    '".addslashes(trim($data[2]))."',                    '".date("Y-m-d H:i:s")."'                )            ");            if(!$insert){				$error_sql=$mysql->showerror();				$error_sql=str_replace("Duplicate entry","Duplikat data dengan kode peserta",$error_sql);				$error_sql=str_replace("for key 'username'","",$error_sql);					//Duplicate entry 'TKJ-1001' for key 'username'. 				$gagal=true;				continue;			}                     }        //echo $skip."<br/>";        $skip++;           } if(!$gagal){$mysql->commit();$mysql->autocommit(true);redirecto(_BERHASILUPLOADMEMBER,"success","view");}else{$mysql->rollback();	$mysql->autocommit(true);redirecto($error_sql,"error","upload_csv");}} }if($action=="save"){	if(Form::isValid("reguser",false) and $_POST['form']=='reguser') 	{  	$username=trim(cleanInput($_POST['username']));	$ulogin=md5($_POST['username']);	$fullname=cleanInput($_POST['fullname']);	$class=trim(cleanInput($_POST['class']));	/*VALIDASI*/	$r=$mysql->query("SELECT id FROM quiz_member WHERE username='$username'");	if($r and $mysql->numrows($r)>0)	{	//msg_warning(_KODESAMA,"error");	Form::setError("reguser", _KODESAMA);	header("location:".backendurl("$modul/add"));	exit();	}	/*END VALIDASI*/	/*	$password=md5(sha1($_POST['password']));	$password2=md5(sha1($_POST['password2']));	if($password!=$password2)	{	Form::setError("reguser", "Error: Incorrect Password");	header("location:".backendurl("$modul/add"));	exit();	}	$level=cleanInput($_POST['level'],"numeric");	*/ 	$status=cleanInput($_POST['status'],"numeric");		$sql="INSERT INTO $modul(username,class,fullname,status,lastmodify) values ('$username','$class','$fullname','$status',NOW())";		$r=$mysql->query($sql);	if($r)	{	reset_member($username);		$action="view";	}	Form::clearValues("reguser"); 	}	else	{	$action="add";	}	}if($action=="update"){	$id=cleanInput($_POST['id'],'numeric');	if(Form::isValid("updateuser",false) and $_POST['form']=='updateuser') 	{  	$username=trim(cleanInput($_POST['username']));	$fullname=cleanInput($_POST['fullname']);	$class=trim(cleanInput($_POST['class']));	/*VALIDASI*/	$r=$mysql->query("SELECT id FROM quiz_member WHERE username='$username' AND id<>$id");	if($r and $mysql->numrows($r)>0)	{	Form::setError("updateuser", _KODESAMA);	header("location:".backendurl("$modul/edit/$id"));	exit();	}	/*END VALIDASI*/	$r_update=array();				$status=cleanInput($_POST['status'],"numeric");		$sql="UPDATE $modul set ";	$r_update[]="username='$username'";	$r_update[]="fullname='$fullname'";	$r_update[]="status='$status'";	$r_update[]="lastmodify=NOW()";	$r_update[]="class='$class'";	$sql.=join(",",$r_update);	$sql.=" WHERE id=$id";	$r=$mysql->query($sql);	if($r)	{	reset_member($username);		Form::clearValues("updateuser"); 	msg_warning(_BERHASILUPDATEUSER,"success");	header("location:".backendurl("$modul/view"));	exit();	}	else	{	msg_warning(_GAGALUPDATEUSER,"success");	header("location:".backendurl("$modul/edit/$id"));	exit();	}		}	else	{	msg_warning(_GAGALUPDATEUSER,"success");	header("location:".backendurl("$modul/edit/$id"));	exit();	}}if($action=="del"){	if($_SESSION['s_level']<=0){redirecto(_TIDAKBERHAK,"error","view");}	$r=$mysql->query("SELECT * from $modul where id=$id");	$d=$mysql->assoc($r);if($_SESSION['s_level']<$d['level']){redirecto(_TIDAKBERHAK,"error","view");}	$sql="DELETE FROM $modul WHERE id=$id";	$r=$mysql->query($sql);	if($r)	{		reset_member($d['username']);		$pathfoto=$config['userfiles']."/quiz_member/source/".$d['username'].".jpg";		if(file_exists($pathfoto)){		unlink($pathfoto);		}else{			$pathfoto=$config['userfiles']."/quiz_member/source/".$d['username'].".jpeg";			if(file_exists($pathfoto)){			unlink($pathfoto);			}		}			header("location:".backendurl("$modul/view"));	}}//refresh jsonif($action!=""){
	//generate_member_json();
}?>