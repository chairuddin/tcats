<?phpif($action=="download_tryout_excel"){error_reporting(E_ALL);ini_set('display_errors', FALSE);ini_set('display_startup_errors', FALSE);date_default_timezone_set('Asia/Jakarta');if (PHP_SAPI == 'cli')	die('This example should only be run from a Web Browser');// Create new PHPExcel object$objPHPExcel = new PHPExcel();// Set document properties$objPHPExcel->getProperties()->setCreator("Romli")							 ->setLastModifiedBy("Romli")							 ->setTitle("Ujian Online Berbasis Komputer")							 ->setSubject("Ujian Online Berbasis Komputer")							 ->setDescription("Ujian Online Berbasis Komputer")							 ->setKeywords("Ujian Online Berbasis Komputer")							 ->setCategory("Ujian Online Berbasis KOmputer");//generate field tambahan	$join_field="";$nama_field=array();$field_tambahan=array();$qfield_tambahan=$mysql->query("SELECT id,quiz_info FROM quiz_schedule WHERE tryout_id=".cleanInput($_GET['tryout_id']));if($qfield_tambahan and $mysql->numrows($qfield_tambahan)>0){	while($dfield_tambahan=$mysql->assoc($qfield_tambahan)){	$r_field_tambahan=json_decode($dfield_tambahan['quiz_info'],true);	$field_tambahan[]="(SELECT score FROM quiz_done WHERE member_id=q.member_id AND schedule_id='".$dfield_tambahan['id']."') '".$r_field_tambahan['code']."'";	$nama_field[]=$r_field_tambahan['code'];	}	if(count($field_tambahan)>0){	$join_field=",".join(", ",$field_tambahan);	}}//END generate field tambahan	$id=cleanInput($id);	$sql="SELECT * FROM (SELECT q.member_id,sum(q.score) total_skor,count(q.id) jumlah_ujian,q.member_code,q.member_fullname,m.class,m.jurusan,m.ruang $join_field FROM quiz_done q LEFT JOIN quiz_member m ON (q.member_id=m.id)WHERE is_done=1 AND schedule_id IN(select id FROM quiz_schedule WHERE tryout_id=".$_GET['tryout_id'].")GROUP BY member_id) aORDER BY a.total_skor DESC";$r=$mysql->query($sql);// Add some data$array_abjad=array("I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","AA","AB","AC","AD","AE","AF","AG","AH","AJ","AK","AL","AM","AN","AO","AP","AP","AP","AP","AQ","AR","AS","AT","AU","AV","AW","AX","AY","AZ");$objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A1',_KODELOGIN)            ->setCellValue('B1',_NAMALENGKAP)            ->setCellValue('C1',_KELAS)            ->setCellValue('D1',_JURUSAN)            ->setCellValue('E1',_RUANG)            ->setCellValue('F1',_JMLUJIAN);            $index=0;			if(count($nama_field)>0){				foreach($nama_field as $i =>$v){					$objPHPExcel->setActiveSheetIndex(0)->setCellValue($array_abjad[$i].'1',$v);					$index=$i;				}			$index++;			}						$objPHPExcel->setActiveSheetIndex(0)->setCellValue($array_abjad[$index].'1',_SCORE);$no=1;while($d=$mysql->assoc($r)){		$no++;		$objPHPExcel->setActiveSheetIndex(0)            ->setCellValue('A'.$no,$d['member_code'])            ->setCellValue('B'.$no,$d['member_fullname'])            ->setCellValue('C'.$no,$d['class'])            ->setCellValue('D'.$no,$d['jurusan'])            ->setCellValue('E'.$no,$d['ruang'])            ->setCellValue('F'.$no,$d['jumlah_ujian']);				if(count($nama_field)>0){		foreach($nama_field as $i =>$v){			$objPHPExcel->setActiveSheetIndex(0)->setCellValue($array_abjad[$i].$no,$d[$v]);			$index=$i;		}		$index++;		}    		$objPHPExcel->setActiveSheetIndex(0)->setCellValue($array_abjad[$index].$no,$d['total_skor']);}$file_name="";$q_schedule=$mysql->query("SELECT title_id,date_format(created_date,'%y%m%d') created_date FROM quiz_tryout WHERE id=".cleanInput($_GET['tryout_id']));	if($q_schedule and $mysql->numrows($q_schedule)>0){		while($d=$mysql->assoc($q_schedule)){			$file_name=$d['title_id']."-".$d['created_date'];		}	}	$filename=$file_name;$sheet_title="$file_name";// Rename worksheet$objPHPExcel->getActiveSheet()->setTitle($sheet_title);// Set active sheet index to the first sheet, so Excel opens this as the first sheet$objPHPExcel->setActiveSheetIndex(0);////////////////////////////////////////// Redirect output to a clientâ€™s web browser (Excel5)header('Content-Type: application/vnd.ms-excel');header('Content-Disposition: attachment;filename="'.$filename.'.xls"');header('Cache-Control: max-age=0');// If you're serving to IE 9, then the following may be neededheader('Cache-Control: max-age=1');// If you're serving to IE over SSL, then the following may be neededheader ('Expires: Mon, 26 Jul 1997 05:00:00 GMT'); // Date in the pastheader ('Last-Modified: '.gmdate('D, d M Y H:i:s').' GMT'); // always modifiedheader ('Cache-Control: cache, must-revalidate'); // HTTP/1.1header ('Pragma: public'); // HTTP/1.0$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel5');$objWriter->save('php://output');exit;}?>