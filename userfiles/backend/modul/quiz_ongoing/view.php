<?php//$col_back="<input type=\"button\" class=\"btn back\" onclick=\" window.location.href='".backendurl("quiz_ongoing/view")."';\" value=\"Back\">";if(($_GET['filter']=="" OR $_GET['schedule_id']=="") AND !$action=="tambahan" ){header("location:".backendurl(""));exit();}if($action=="confirm_refresh"){	if($_POST['update_score']==1) {		$schedule_id=cleanInput($_POST['schedule_id']);	$r_join_id=array();	$q=$mysql->query("SELECT id FROM quiz_done WHERE schedule_id=$schedule_id");	if($q and $mysql->num_rows($q)>0) {		while($d = $mysql->fetch_assoc($q)) 		{			$r_join_id[]=$d['id'];		}	}	if(count($r_join_id)>0) {				$join_id=join(",",$r_join_id);		scoring_ulang($join_id,0);				redirecto("Perhitungan ulang sudah dilakukan","success","/?filter=sudah_ujian&schedule_id=$schedule_id");	} else {		redirecto("Tidak ada peserta dalam ujian ini.","warning","/?filter=sudah_ujian&schedule_id=$schedule_id");	}	}		$form_title="Refresh Score";$jumlah_peserta=$mysql->get1value("SELECT count(id) FROM quiz_done WHERE schedule_id=$id ");echo '<div class="rows"><div class="col-md-6">';echo '<div class="card">	<div class="card-header">	  <h3 class="card-title">'.$form_title.'</h3>	</div>	<!-- /.card-header -->	<div class="card-body">	';echo '<form method="post" >';echo '<input type="hidden" name="schedule_id" value="'.$id.'" />';echo '<i>Anda setuju untuk melakan proses perhitungan ulang terhadap '.$jumlah_peserta.' peserta?</i>';echo '<br/>';echo '<br/>';echo '<button class="btn btn-primary" type="submit" value="1" name="update_score">Setuju dan Proses</button> &nbsp;&nbsp;&nbsp;';echo '<input type="btn button" value="Batal" name="" onclick="history.go(-1);" class="btn" id="reguser-element-5">';echo '</form>';echo '</div>';echo '</div>';echo '</div></div>';}if($action=="tambahan"){	if($_POST['update_waktu']==1) {		$done_id=cleanInput($_POST['quiz_done_id']);	$waktu=cleanInput($_POST['waktu']);	$schedule_id=cleanInput($_POST['schedule_id']);	$nama=$mysql->get1value('SELECT member_fullname FROM quiz_done WHERE id='.$done_id);	$q=$mysql->query("UPDATE quiz_done SET 	quiz_duration=$waktu, is_done=3,end_time='0000-00-00 00:00:00',check_point=start_time_real  WHERE id=$done_id ");		redirecto("Tambahan waktu $waktu menit kepada $nama berhasil  dilakukan","success","/?filter=sudah_ujian&schedule_id=$schedule_id");}		$form_title="Tambahan Waktu";list($d)=$mysql->query_data("SELECT d.*,(select count(id) FROM quiz_done_essay WHERE id_quiz_done=d.id) terjawab_essay,(select answer FROM quiz_done_complex WHERE id_quiz_done=d.id) jawaban_complex  FROM quiz_done d WHERE d.id=$id ");$r_json_soal=get_soal_json($d['quiz_id']);$jumlah_soal_pg=count($r_json_soal['soal_ganda']);$jumlah_soal_complex=count($r_json_soal['soal_complex']);$jumlah_soal_essay=count($r_json_soal['soal_essay']);$total_soal=$jumlah_soal_pg+$jumlah_soal_complex+$jumlah_soal_essay;$terjawab=0;$r_terjawab=json_decode($d['answer_temp']);//$total_soal=0;if(count($r_terjawab)>0){	foreach($r_terjawab as $i => $v){		//$total_soal++;			if($v!=""){				$terjawab++;			}	}}$r_terjawab_complex=json_decode($d['jawaban_complex']);if(count($r_terjawab_complex)>0){	foreach($r_terjawab_complex as $i => $v){			if($v!=""){				$terjawab++;			}	}}$terjawab+=$d['terjawab_essay'];echo '<div class="card">	<div class="card-header">	  <h3 class="card-title">'.$form_title.'</h3>	</div>	<!-- /.card-header -->	<div class="card-body">	';echo '<form method="post" >';echo '<input type="hidden" name="quiz_done_id" value="'.$id.'" />';echo '<input type="hidden" name="schedule_id" value="'.$_GET['schedule_id'].'" />';echo '<table cellpadding="5" cellspacing="0">';echo '<tr><td>Kode Peserta</td><td>'.$d['member_code'].'</td></tr>';echo '<tr><td>Nama</td><td>'.$d['member_fullname'].'</td></tr>';echo '<tr><td>Kelas</td><td>'.$d['member_class'].'</td></tr>';echo '<tr><td>Ujian</td><td>'.$d['quiz_title_id'].'</td></tr>';echo '<tr><td>Terjawab</td><td>'.$terjawab.' dari '.$total_soal.' soal</td></tr>';echo '<tr><td>Tidak Terjawab</td><td>'.($total_soal-$terjawab).' soal</td></tr>';echo '<tr><td>Tambahan Waktu</td><td><input class="input-waktu" style="width:70px;" type="number" name="waktu" value="30" step="5" min="0" 300" />&nbsp;Menit</td></tr>';echo '</table>';echo '<br/>';echo '<i>Siswa akan masuk ke antrian ujian kembali dan akan dinyatakan selesai ujian jika sudah melaksanakan ujian kembali. </i><br/>';echo '<i>Anda setuju memberikan waktu tambahan kepada siswa ini untuk melakukan ujian kembali dengan jawaban yang sudah tersedia ?</i>';echo '<br/>';echo '<br/>';echo '<button class="btn btn-primary" type="submit" value="1" name="update_waktu">Setuju dan Simpan</button> &nbsp;&nbsp;&nbsp;';echo '<input type="btn button" value="Batal" name="" onclick="history.go(-1);" class="btn" id="reguser-element-5">';echo '</form>';echo '</div>';echo '</div>';}if($action=="search"){$col_back="<input type=\"button\" class=\"btn back\" onclick=\" window.location.href='".backendurl("quiz_ongoing/?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id'])."';\" value=\"Back\">";}if($action=="" or $action=="search" or $action=="view"){$form_search=form_search($keyword,"?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id']);}if($action=="view" or $action=="" or $action=="search"){if($_GET['filter']=="sudah_ujian"){$form_title="Sudah Ujian";}if($_GET['filter']=="sedang_ujian"){$form_title="Sedang Ujian";}	if($_GET['filter']=="pending"){$form_title="Pending";}	$sql="SELECT d.*,m.username,fullname,class,(select count(id) FROM quiz_done_essay WHERE id_quiz_done=d.id) terjawab_essay,(select answer FROM quiz_done_complex WHERE id_quiz_done=d.id) jawaban_complex FROM quiz_done d LEFT JOIN quiz_member m ON d.member_id=m.id WHERE 1 ";if($_SESSION['s_level']==0){//	$sql.=" AND quiz_id IN (SELECT id FROM quiz_master WHERE created_by='".$_SESSION['s_id']."') ";}if($_GET['filter']=="sudah_ujian" and $_GET['schedule_id']!=""){	$sql.=" AND schedule_id='".$_GET['schedule_id']."' AND is_done=1 ";}if($_GET['filter']=="sedang_ujian" and $_GET['schedule_id']!=""){	$sql.=" AND schedule_id='".$_GET['schedule_id']."' AND is_done=0";}if($_GET['filter']=="pending" and $_GET['schedule_id']!=""){	$sql.=" AND schedule_id='".$_GET['schedule_id']."' AND is_done=3 ";	}if($action=="search"){$sql.=" AND (m.username like '%$keyword%' or m.fullname like '%$keyword%')";} if($is_wali_kelas){	if(count($config_wali_kelas)>0) {		foreach($config_wali_kelas as $kelas) {			$sql_r[]=" FIND_IN_SET('$kelas',class) ";		}		}}if(count($sql_r)>0) {	$kondisi.=" AND (".join(" or ",$sql_r).") ";}$sql.=" $kondisi ";$r=$mysql->query($sql);$total_records = $mysql->numrows($r);$start = $screen * $max_page_list;$pages = ceil($total_records/$max_page_list);//if ($pages>1) $col_pagination=pagination($screen);//LIMIT $start, $max_page_list$sql.="  order by $sort_by $sort_order  ";$r=$mysql->query($sql);$q_info=$mysql->query("SELECT * FROM quiz_schedule WHERE id=".$_GET['schedule_id']);$d_info=$mysql->assoc($q_info);$info=json_decode($d_info['quiz_info'],true);$tanggal_ujian=date("Y-m-d",strtotime($d_info['tanggal']));$tanggal_expired=date("Y-m-d",strtotime($d_info['tanggal_expired']));$jam_ujian=date("H:i",strtotime($d_info['tanggal']));$jam_expired=date("H:i",strtotime($d_info['tanggal_expired']));$hari_sama=$tanggal_ujian==$tanggal_expired?1:0;ob_start();echo "<table><tr><td>Token</td><td>:</td><td>&nbsp;".$d_info['token']."</td></tr><tr><td>Kode Soal</td><td>:</td><td>&nbsp;".$info['code']."</td></tr><tr><td>Nama Soal</td><td>:</td><td>&nbsp;".$info['title_id']."</td></tr>";if($hari_sama){echo "<tr><td>Tanggal</td><td>:</td><td>&nbsp;".$tanggal_ujian."</td></tr>";echo "<tr><td>Jam</td><td>:</td><td>&nbsp;$jam_ujian - $jam_expired</td></tr>";}else{echo "<tr><td>Mulai</td><td>:</td><td>&nbsp;Pukul ".$jam_ujian.", ".$tanggal_ujian."</td></tr>";echo "<tr><td>Berakhir</td><td>:</td><td>&nbsp;Pukul ".$jam_expired.", ".$tanggal_expired."</td></tr>";	}echo "</table>";if($_GET['filter']=="sudah_ujian" and $_GET['schedule_id']!=""){	echo '<a class="btn btn-warning" href="'.backendurl("quiz_ongoing/confirm_refresh/".$_GET['schedule_id']).'">Refresh Score</a>';}$info_ujian = ob_get_clean();ob_start();echo "<div class='bulk_action'>";echo "<select required='required' id='bulk_action' class='' name='bulk_action'><option value=''>Pilih aksi</option>".(($_GET['filter']=='sedang_ujian' and $_GET['filter']!='sudah_ujian')?"<option value='pending'>Pending</option>":"")."".($_GET['filter']!='sudah_ujian'?"<option value='paksa_selesai'>Paksa Selesai</option>":"")."".($_GET['filter']=='sudah_ujian'?"<option value='reset-ulang'>Reset</option>":"<option value='reset'>Reset</option>")."</select><input type='hidden' name='schedule_id' value='".$_GET['schedule_id']."' /><input type='hidden' name='submit_bulk'  value='1'/><input type='hidden' name='urlfilter'  value='".$_GET['filter']."'/><button class='btn btn-primary' type='button'  onclick='check_form()'   class='btn btn-default'>Submit</button></div>";$bulk_form=ob_get_clean();echo "<form name='bulk-form'  id='bulk-form' method='post' action='".backendurl("quiz_ongoing/?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id'])."'>";echo '<div class="card">	<div class="card-header">	  <h3 class="card-title">'.$form_title.'</h3>	</div>	<!-- /.card-header -->	<div class="card-body">	';echo $info_ujian;echo "<hr/>$bulk_form<table id='data-table' class='table table-bordered table-striped responsive no-wrap'>";echo "<thead><tr><th><input type='checkbox' name='check_all' id='check_all' value='1' /></th><th>No</th><th>Kode</th><th>Nama</th><th>Kelas</th><th>Jawab</th><th>Waktu</th>";if($_GET['filter']!='sudah_ujian'){
echo "<th>Aktif</th> ";	echo "<th>Sisa Waktu</th> ";	
}else{
echo "<th>Selesai</th> ";		echo "<th>Waktu</th> ";		echo "<th>Skor</th> ";		
}echo "<th>Action</th>";echo "</tr></thead>";$no=($start+1);echo '<tbody>';$this_time=strtotime(date("Y-m-d H:i:s"));while($d=$mysql->assoc($r)){$start_time=$d['start_time'];$checkpoint=$d['check_point'];$checkpoint_time=strtotime($checkpoint);$quiz_duration= ($d['quiz_duration']*60);$end_time=strtotime($start_time)+$quiz_duration;//$terjawab=count();$terjawab=0;$r_terjawab=json_decode($d['answer_temp']);if(count($r_terjawab)>0){
	foreach($r_terjawab as $i => $v){
			if($v!=""){
				$terjawab++;
			}
	}
}$r_terjawab_complex=json_decode($d['jawaban_complex']);if(count($r_terjawab_complex)>0){	foreach($r_terjawab_complex as $i => $v){			if($v!=""){				$terjawab++;			}	}}$terjawab+=$d['terjawab_essay'];//$terjawab=count(json_decode($d['answer_temp'],true));if($_GET['filter']=="pending"){$quiz_left_duration=round(($end_time-$checkpoint_time)/60);	}else{$quiz_left_duration=round(($end_time-$this_time)/60);$quiz_left_duration=$quiz_left_duration<=0?0:$quiz_left_duration;	}$quiz_left_duration=round(($end_time-$checkpoint_time)/60);if($checkpoint=="0000-00-00 00:00:00"){
$activity=$sisa_durasi="-";	
}else{$activity_time=$this_time-$checkpoint_time;if($activity_time<60){
	$activity=$activity_time." detik lalu";	
}else{
	$activity=round(($activity_time)/60,0)." menit lalu";	
}
$sisa_durasi=($quiz_left_duration>=0?$quiz_left_duration." menit":($quiz_left_duration>=$d['quiz_duration']?"-":"0 menit"));
}$action_pending=$action_tambah=$action_reset=$action_selesai='';echo "<tr class=\"".($d['is_done']=="3"?"pindah_tempat":"")."\"><td><input type='checkbox'  class='c_ujian_id' name='ujian_id[]' value='".$d['id']."' /></td><td>$no</td><td>".$d['username']."</td><td>".$d['fullname']."</td><td>".$d['class']."</td><td>".$terjawab."</td><td>".$d['start_time']."</td>";if($_GET['filter']!='sudah_ujian'){echo "<td>".$activity."</td><td style=\"text-align:center\">".$sisa_durasi."</td>";}else{$pengerjaan=(strtotime($d['end_time'])-strtotime($d['start_time']))/60;$pengerjaan=$pengerjaan>$d['quiz_duration']?$d['quiz_duration']:$pengerjaan;echo "<td>".$d['end_time']."</td>";echo "<td>".round($pengerjaan,0)." menit</td>";echo "<td style=\"text-align:right\">".$d['score']."|".$d['score_essay']."</td>";}echo "<td>";if($_GET['filter']!="sudah_ujian"){/*echo ($d['is_done']!=3?"<a class='button_action action-pindah dialog-confirm-pindah' title='Pending' href='#' tujuan='".backendurl("quiz_ongoing/pindah_tempat/".$d['id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id']."'><i class=\"glyphicon-iphone_exchange\"></i></a>":"")."<a class='button_action action-selesai' title='Paksa Selesai' tujuan='".backendurl("quiz_ongoing/selesai_ujian/".$d['id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id']."' href='#'><i class=\"icon-flag\"></i></a>";*/ if($d['is_done']!=3) {$title="Pending Ujian ".$d['fullname'];$message="Siswa ".$d['fullname']." bisa masuk lagi dengan sisa waktu dan jawaban terakhir";$btn_name1="Pending";$url=backendurl("quiz_ongoing/pindah_tempat/".$d['id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id'];$class="btn-warning";$icon="fa-sync";$action_pending= btn_general($title,$message,$url,$btn_name1,$class,$icon);}$title="Paksa selesai ".$d['fullname'];$message="Status Ujian ".$d['fullname']." akan dianggap selesai dengan skor sesuai jawaban terakhir ";$btn_name1="Ujian Selesai";$url=backendurl("quiz_ongoing/selesai_ujian/".$d['id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id'];$class="btn-warning";$icon="fa-flag";$action_selesai= btn_general($title,$message,$url,$btn_name1,$class,$icon);$title="Reset Ujian ".$info['title_id'];$message="Nilai ".$d['fullname']." akan dihapus dan harus mengulang ujian kembali?";$btn_name1="Reset";$url=backendurl("quiz_ongoing/del/".$d['id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id'];$class="btn-danger";$icon="fa-trash";$action_reset= btn_general($title,$message,$url,$btn_name1,$class,$icon);//echo "<a data-toggle='modal' tujuan='".$url."' href='#' class='button_action action-reset' title='Reset'><i class='glyphicon-remove'></i></a>";}else{//echo "<a data-toggle='modal' tujuan='".backendurl("quiz_ongoing/tambahan/".$d['id']."?schedule_id=".$_GET['schedule_id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id']."' href='#' class='button_action action-tambah' title='Tambahan Waktu'><i class='icon-time'></i></a>";		/*BTN TAMBAH*/$url=backendurl("quiz_ongoing/tambahan/".$d['id']."?schedule_id=".$_GET['schedule_id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id'];$title="Tambah Waktu ".$info['title_id'];$message="Anda akan diarahkan kehalaman konfigurasi tambah waktu ujian untuk ".$d['fullname'];$btn_name1="Setuju";$class="btn-success";$icon="fa-user-clock";$action_tambah= btn_general($title,$message,$url,$btn_name1,$class,$icon);/*END BTN TAMBAH*//*BTN RESET*/$title="Reset Ujian ".$info['title_id'];$message="Nilai ".$d['fullname']." akan dihapus dan harus mengulang ujian kembali?";$btn_name1="Reset";$url=backendurl("quiz_ongoing/del/".$d['id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id'];$class="btn-danger";$icon="fa-trash";$action_reset= btn_general($title,$message,$url,$btn_name1,$class,$icon);/*END BTN RESET*///echo "<a data-toggle='modal' tujuan='".backendurl("quiz_ongoing/del/".$d['id'])."?filter=".$_GET['filter']."&schedule_id=".$_GET['schedule_id']."' href='#' class='button_action action-ulang' title='Reset'><i class='glyphicon-remove'></i></a>";	
}echo '<div class="btn-group btn-group-sm">'.$action_pending.$action_reset.$action_selesai.$action_tambah.'</div>';echo "</td>";$no++;echo "</tr>";}echo "</tbody>";echo "</table></form>";echo '		</div></div><br/><br/><br/><div id="dialog-confirm-ulang" title="Reset Ujian!" style="display:none;">	<p>Siswa sudah melaksanakan ujian!, <br/>	Nilai siswa akan dihapus dan harus mengulang ujian kembali?<br/></p></div>	<div id="dialog-confirm-tambah" title="Tambah waktu ujian!" style="display:none;">	Anda akan menuju form untuk menambah waktu ujian siswa?<br/></p></div>	<div id="dialog-confirm-ulang-bulk" title="Reset Ujian!" style="display:none;">	<p>Siswa sudah melaksanakan ujian!, <br/>	Nilai siswa akan dihapus dan harus mengulang ujian kembali?<br/></p></div>	<div id="dialog-confirm-reset" title="Reset Ujian!" style="display:none;">	<p>Ujian siswa akan dihentikan dari perangkat saat ini, <br/>	Nilai siswa akan dihapus dan harus mengulang ujian kembali?<br/></p></div>	<div id="dialog-confirm-pindah" title="Pending Ujian!" style="display:none;">	<p>Ujian siswa akan dipending, <br/>	Siswa bisa login kembali dengan jawaban dan sisa waktu saat ini<br/>	</p></div>	<div id="dialog-confirm-selesai" title="Ujian dipaksa selesai!" style="display:none;">	<p>Ujian siswa akan dihentikan dari perangkat <br/>saat ini dan dianggap sudah melaksanakan ujian! <br/>	</p></div>	<--<div id="dialog-confirm-pindah-bulk" title="Bulk - Pending Ujian!" style="display:none;">	<p>Ujian siswa akan dipending, <br/>	Siswa bisa login kembali dengan jawaban dan sisa waktu saat ini<br/>	</p></div><div id="dialog-confirm-selesai-bulk" title="Bulk - Ujian dipaksa selesai!" style="display:none;">	<p>Ujian siswa akan dihentikan dari perangkat <br/>saat ini dan dianggap sudah melaksanakan ujian! <br/>	</p></div>	--><div class="modal fade" id="dialog-bulk" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">  <div class="modal-dialog" role="document">    <div class="modal-content">      <div class="modal-header">        <h4 class="modal-title" id="myModalLabel">Bulk - Reset Ujian!</h4>        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>      </div>      <div class="modal-body" id="myModalContent">        <p>Ujian siswa akan dihentikan dari perangkat saat ini, <br/>		Siswa bisa melakukan ujian ulang dengan spesifikasi <br/>durasi ujian yang telah ditentukan<br/></p>      </div>      <div class="modal-footer">        <button type="button" class="btn btn-default" data-dismiss="modal">Batal</button>        <button type="button" class="btn btn-primary" onclick="bulk_submit()">Setuju</button>      </div>    </div>  </div></div>';/////////////////////////////////BATAS BARU$script_js.=<<<END<script type="text/javascript">function bulk_submit() {	$("#bulk-form").submit();}function check_form() {bulk_action=$( "#bulk_action" ).val();if(bulk_action=='pending'){	//$("#dialog-confirm-pindah-bulk").dialog("open");	$("#myModalContent").html("<p>Siswa bisa login ulang dengan sisa waktu terakhir dan jawaban terakhir</p>");	$("#myModalLabel").html("Bulk - Pending");	setTimeout(function(){		$('#dialog-bulk').modal('show');	},200);}if(bulk_action=='reset'){	//$("#dialog-confirm-reset-bulk").dialog("open");	//$('#dialog-confirm-reset-bulk').modal('show');	$("#myModalContent").html("	 <p>Siswa ujian ulang dimulai dari awal. Semua data jawaban akan dihapus</p>");	$("#myModalLabel").html("Bulk - Reset Ujian");	setTimeout(function(){		$('#dialog-bulk').modal('show');	},200);}if(bulk_action=='paksa_selesai'){	//$("#dialog-confirm-selesai-bulk").dialog("open");	$("#myModalContent").html("	<p>Ujian siswa akan dihentikan dari perangkat. Skor dihitung dari jawaban terakhir <br/>");	$("#myModalLabel").html("Bulk - Paksa Selesai");	setTimeout(function(){		$('#dialog-bulk').modal('show');	},200);	}return false;}$(document).ready(function(){	$('#data-table').DataTable({					'searching'   : true,			'ordering'    : true,			'responsive'  : true,			'pageLength': 1000,				});			$('.c_ujian_id').click(function(){			ada=false;			$('.c_ujian_id').each(function(){				if ($(this).is(':checked')) {					ada=true;				}				if(ada){					$('.bulk_action').show();				}else{					$('.bulk_action').hide();				}			});	});	$('.bulk_action').hide();	 $('[name="check_all"]').change(function()      {        if ($(this).is(':checked')) {			$('.c_ujian_id').prop('checked',true);			$('.bulk_action').show();			        }else{			$('.c_ujian_id').prop('checked',false);			$('.bulk_action').hide();		}      });        	});</script>END;}?>