<?php$kondisi="";if($_SESSION['s_level']==0 and $id!=""){	$kondisi=" AND created_by='".$_SESSION['s_id']."'";	$r=$mysql->query("SELECT * from quiz_master where id=$id $kondisi");	if($r and $mysql->numrows($r)==0){	msg_warning("Anda tidak berhak mengakses soal tersebut","error");	header("location:".backendurl("quiz_master/view/"));	exit();		}}	if($action=="download"){	include ("mysql_backup.php");		$backup_obj = new MySQL_Backup();	$backup_obj->server = $host[$_SERVER['HTTP_HOST']]['db_host'];	$backup_obj->username = $host[$_SERVER['HTTP_HOST']]['db_user'];	$backup_obj->password = $host[$_SERVER['HTTP_HOST']]['db_pass'];	$backup_obj->database = $host[$_SERVER['HTTP_HOST']]['db_name'];		if (!$backup_obj->_Connect())	{	$sukses=false;	$msg_status=alert(_ERROR,'Gagal konek');	}	mysqli_autocommit($backup_obj->link_id,false);		$r_id=$_POST['id_master'];	if(count($r_id)>0){		$id_selected=join(",",$r_id);	}else{		msg_warning("Pilih master soal yang ingin di download","error");		header("location:".backendurl("$modul/view"));		exit();	}	$backup_obj->queries['quiz_master']="select * from quiz_master WHERE id in ($id_selected)";	$backup_obj->queries['quiz_detail']="select * from quiz_detail WHERE quiz_id in ($id_selected)";	$backup_obj->queries['quiz_essay']="select * from quiz_essay WHERE quiz_id in ($id_selected)";	$backup_obj->comments = false;				//Directory on the server where the backup file will be placed. Used only if task parameter equals MSB_SAVE.		$backup_obj->backup_dir = $config['userdir'].'backend/modul/quiz_master/backup';					//Default file name format.		$backup_obj->fname_format = 'd_m_Y';	//--------------------- END - OPTIONAL PREFERENCE VARIABLES ---------------------		//Use GZip compression 		$backup_obj->use_gzip = true;		$backup_obj->stand_in_view = false;			//--------------------- END - REQUIRED EXECUTE VARIABLES ----------------------	  $filename="BANK_SOAL_".date("Ymd-His");	  $backup_obj->nama_simpan =$filename;	  $backup_obj->Execute($filename);	  $backup_obj->Download();	}if($action=="upload"){		$fname=$_FILES['filename']['tmp_name'];		$oname=$_FILES['filename']['name'];				include_once ("mysql_backup.php");		//----------------------- EDIT - REQUIRED SETUP VARIABLES -----------------------		$backup_obj = new MySQL_Backup();		$backup_obj->server = $host[$_SERVER['HTTP_HOST']]['db_host'];		$backup_obj->username = $host[$_SERVER['HTTP_HOST']]['db_user'];		$backup_obj->password = $host[$_SERVER['HTTP_HOST']]['db_pass'];		$backup_obj->database = $host[$_SERVER['HTTP_HOST']]['db_name'];		//------------------------ END - REQUIRED SETUP VARIABLES -----------------------		$backup_obj->Restore($fname);		$sukses=$backup_obj->status_commit;				if($sukses)		{				unlink($fname);			msg_warning("Master soal berhasil diupload","success");			header("location:".backendurl("$modul/view"));			exit();		}		else		{			msg_warning($backup_obj->message,"error");			header("location:".backendurl("$modul/view"));			exit();		}		}if($action=="save_as"){	if(Form::isValid("{$modul}save_as",false) and $_POST['form']=="{$modul}save_as") 	{	$id=cleanInput($_POST['id'],'numeric');	$url_empty=array();	$url_noempty="";	${"code"}=cleanInput($_POST["code"],"field");	${"duration"}=cleanInput($_POST["duration"]);	${"kkm"}=cleanInput($_POST["kkm"]);	${"score"}=cleanInput($_POST["score"]);	${"is_random"}=cleanInput($_POST["is_random"]);	${"is_random_option"}=cleanInput($_POST["is_random_option"]);	${"created_by"}=cleanInput($_POST["created_by"]);		/*VALIDASI*/		$r=$mysql->query("SELECT id FROM quiz_master WHERE code='$code'");	if($r and $mysql->numrows($r)>0)	{	msg_warning(_GANTIKODESAMA,"error");	header("location:".backendurl("$modul/copy/$id"));	exit();	}	/*END VALIDASI*/	foreach($list_lang as $i =>$v)	{	${"title_$v"}=cleanInput($_POST["title_$v"]);	${"content_$v"}=allowHtml($_POST["content_$v"]);	${"url_$v"}=cleanInput($_POST["title_$v"],"url");	if(${"url_$v"}==""){$url_empty[]="url_$v";}	if($url_noempty=="" and ${"url_$v"}!=""){$url_noempty="url_$v";}	}	//jika ada url yang kosong ambil yang pertama tidak kosong	if(count($url_empty)>0)	{		foreach($url_empty as $i =>$v)		{		$$v=$$url_noempty;		}	}		$modifiedfilename="";		$uniqid=uniqid();		$sql="INSERT INTO $modul (";	$sql.="id";	foreach($list_lang as $i =>$v)	{	$sql.=",title_$v";	$sql.=",content_$v";	}	$sql.=",is_random";	$sql.=",is_random_option";	$sql.=",duration";	$sql.=",score";	$sql.=",kkm";	$sql.=",code";	$sql.=",uniqid";	$sql.=",created_by";	$sql.=",created_date";	if($modifiedfilename!="")$sql.=",thumbnail";		$sql.=")";		$sql.=" values (";	$sql.="null";	foreach($list_lang as $i =>$v)	{	$sql.=",'".${"title_$v"}."'";	$sql.=",'".${"content_$v"}."'";	}	$sql.=",'$is_random'";		$sql.=",'$is_random_option'";		$sql.=",'$duration'";	$sql.=",'$score'";	$sql.=",'$kkm'";	$sql.=",'$code'";	$sql.=",'$uniqid'";	$sql.=",'".$created_by."'";		$sql.=",'".$hariini_long."'";		if($modifiedfilename!="")$sql.=",'".$modifiedfilename."'";		$sql.=")";	//die($sql);	$r=$mysql->query($sql);	if($r)	{	$id_baru=$mysql->get1value("SELECT id FROM quiz_master WHERE uniqid='$uniqid'");		$copy=$mysql->query("		INSERT INTO quiz_detail(		question,quiz_id,		A,B,C,D,E,		answer,	model,urutan		) 		SELECT question,$id_baru,		A,B,C,D,E,		answer,	model,urutan FROM quiz_detail WHERE quiz_id='$id' 		");			$copy=$mysql->query("		INSERT INTO quiz_essay(		question,quiz_id,		A,B,C,D,E,		answer,	model,urutan		) 		SELECT question,$id_baru,		A,B,C,D,E,		answer,	model,urutan FROM quiz_essay WHERE quiz_id='$id' 		");				//copy directory	$folder_guru=$mysql->get1value("SELECT username FROM user WHERE id IN(SELECT created_by FROM quiz_master WHERE id='".$id_baru."')");	$folder_soal_asal=$folder_guru."/dir_".$id;	$folder_soal_baru=$folder_guru."/dir_".$id_baru;	if(file_exists(DIR_IMAGES."/source/$folder_guru")){		if(file_exists(DIR_IMAGES."/source/$folder_soal_asal")){			if(file_exists(DIR_IMAGES."/source/$folder_soal_baru")==false){			mkdir(DIR_IMAGES."/source/$folder_soal_baru",0755);			}			xcopy(DIR_IMAGES."/source/$folder_soal_asal",DIR_IMAGES."/source/$folder_soal_baru");		}				}	//end copy directory		//replace url in quiz_detail			$mysql->query("UPDATE quiz_detail SET 	question = REPLACE(question, '$folder_soal_asal', '$folder_soal_baru'),	A = REPLACE(A, '$folder_soal_asal', '$folder_soal_baru'),	B = REPLACE(B, '$folder_soal_asal', '$folder_soal_baru'),	C = REPLACE(C, '$folder_soal_asal', '$folder_soal_baru'),	D = REPLACE(D, '$folder_soal_asal', '$folder_soal_baru'),	E = REPLACE(E, '$folder_soal_asal', '$folder_soal_baru') 	WHERE quiz_id='$id_baru'");	//end replace url in quiz_detail		msg_warning(_BERHASILTAMBAH,"success");	Form::clearValues("{$modul}save_as"); 	header("location:".backendurl("$modul/view"));	exit();	}		}	else	{	Form::clearValues("{$modul}save_as"); 		msg_warning(_GAGALADD,"error");	header("location:".backendurl("$modul/copy/$id"));	exit();	}	}if($action=="save"){	if(Form::isValid("{$modul}add",false) and $_POST['form']=="{$modul}add") 	{		$url_empty=array();	$url_noempty="";	${"code"}=cleanInput($_POST["code"],'code');	${"duration"}=cleanInput($_POST["duration"],'numeric');	${"copy"}=cleanInput($_POST["copy"],'numeric');	${"score"}=cleanInput($_POST["score"],'numeric');	${"kkm"}=cleanInput($_POST["kkm"],'numeric');	${"is_random"}=cleanInput($_POST["is_random"]);	${"is_random_option"}=cleanInput($_POST["is_random_option"]);		/*VALIDASI*/	$r=$mysql->query("SELECT id FROM quiz_master WHERE code='$code' ");	if($r and $mysql->numrows($r)>0)	{	msg_warning(_KODESAMA,"error");	header("location:".backendurl("$modul/add"));	exit();	}	/*END VALIDASI*/	foreach($list_lang as $i =>$v)	{	${"title_$v"}=cleanInput($_POST["title_$v"]);	${"content_$v"}=allowHtml($_POST["content_$v"]);	${"url_$v"}=cleanInput($_POST["title_$v"],"url");	if(${"url_$v"}==""){$url_empty[]="url_$v";}	if($url_noempty=="" and ${"url_$v"}!=""){$url_noempty="url_$v";}	}	//jika ada url yang kosong ambil yang pertama tidak kosong	if(count($url_empty)>0)	{		foreach($url_empty as $i =>$v)		{		$$v=$$url_noempty;		}	}			$modifiedfilename="";		$sql="INSERT INTO $modul (";	$sql.="id";	foreach($list_lang as $i =>$v)	{	$sql.=",title_$v";	$sql.=",content_$v";	}	$sql.=",is_random";	$sql.=",is_random_option";	$sql.=",duration";	$sql.=",score";	$sql.=",kkm";	$sql.=",code";	$sql.=",created_by";	$sql.=",created_date";	if($modifiedfilename!="")$sql.=",thumbnail";		$sql.=")";		$sql.=" values (";	$sql.="null";	foreach($list_lang as $i =>$v)	{	$sql.=",'".${"title_$v"}."'";	$sql.=",'".${"content_$v"}."'";	}	$sql.=",'$is_random'";		$sql.=",'$is_random_option'";		$sql.=",'$duration'";		$sql.=",'$score'";		$sql.=",'$kkm'";		$sql.=",'$code'";		$sql.=",'".$_SESSION['s_id']."'";		$sql.=",'".$hariini_long."'";	if($modifiedfilename!="")$sql.=",'".$modifiedfilename."'";		$sql.=")";	//die($sql);	$r=$mysql->query($sql);	if($r)	{	msg_warning(_BERHASILTAMBAH,"success");	Form::clearValues("{$modul}add"); 	header("location:".backendurl("$modul/view"));	exit();	}		}	else	{	msg_warning(_GAGALADD,"error");	header("location:".backendurl("$modul/add"));	exit();	}	}if($action=="update"){	$id=cleanInput($_POST['id'],'numeric');	$url_empty=array();	$url_noempty="";	${"duration"}=cleanInput($_POST["duration"]);	${"score"}=cleanInput($_POST["score"]);	${"kkm"}=cleanInput($_POST["kkm"]);	${"code"}=cleanInput($_POST["code"],'code');	${"is_random"}=cleanInput($_POST["is_random"]);	${"is_random_option"}=cleanInput($_POST["is_random_option"]);		/*VALIDASI*/		$r=$mysql->query("SELECT id FROM quiz_master WHERE code='$code' AND id<>$id");	if($r and $mysql->numrows($r)>0)	{	msg_warning(_KODESAMA,"error");	header("location:".backendurl("$modul/edit/$id"));	exit();	}	/*END VALIDASI*/	foreach($list_lang as $i =>$v)	{	${"title_$v"}=cleanInput($_POST["title_$v"]);	${"content_$v"}=allowHtml($_POST["content_$v"]);	${"url_$v"}=cleanInput($_POST["title_$v"],"url");	if(${"url_$v"}==""){$url_empty[]="url_$v";}	if($url_noempty=="" and ${"url_$v"}!=""){$url_noempty="url_$v";}	}	//jika ada url yang kosong ambil yang pertama tidak kosong	if(count($url_empty)>0)	{		foreach($url_empty as $i =>$v)		{		$$v=$$url_noempty;		}	}	if(!Form::isValid("update{$modul}",false) or $_POST['form']!="update{$modul}") 	{		redirecto(_GAGALUPDATE,"error","edit/$id");	}	$modifiedfilename="";		$sql_r=array();	$sql="	UPDATE $modul SET ";	foreach($list_lang as $i =>$v)	{	$sql_r[]="title_$v='".${"title_$v"}."'";	$sql_r[]="content_$v='".${"content_$v"}."'";		}	$sql_r[]="duration='".${"duration"}."'";		$sql_r[]="kkm='".${"kkm"}."'";		$sql_r[]="score='".${"score"}."'";		$sql_r[]="is_random='".${"is_random"}."'";		$sql_r[]="is_random_option='".${"is_random_option"}."'";		$sql_r[]="code='".${"code"}."'";		$sql_r[]="modified_by='".$_SESSION['s_id']."'";		$sql_r[]="modified_date='".$hariini_long."'";			if($modifiedfilename!="")$sql_r[]="thumbnail='".$modifiedfilename."'";	$sql.=join(",",$sql_r);	$sql.="	WHERE id=$id";	//die($sql);	$r=$mysql->query($sql);	if($r)	{	Form::clearValues("update{$modul}"); 	msg_warning(_BERHASILUPDATE,"success");	header("location:".backendurl("$modul/view"));	exit();	}	else	{	msg_warning(_GAGALUPDATE,"error");	header("location:".backendurl("$modul/edit/$id"));	exit();	}	}if($action=="del"){$id=cleanInput($id,'numeric');$folder_guru=$mysql->get1value("SELECT username FROM user WHERE id IN(SELECT created_by FROM quiz_master WHERE id='".$id."')");	$folder_soal=$folder_guru."/dir_".$id;	$sql="DELETE FROM $modul WHERE id='$id'";$r=$mysql->query($sql);$sql="DELETE FROM quiz_detail WHERE quiz_id='$id'";$r=$mysql->query($sql);$sql="DELETE FROM quiz_essay WHERE quiz_id='$id'";$r=$mysql->query($sql);if($r){	if($folder_guru!="" and $id!="")	{		if(file_exists(DIR_IMAGES."/source/$folder_guru")){			if(file_exists(DIR_IMAGES."/source/$folder_soal")){				delete_files(DIR_IMAGES."/source/$folder_soal");			}					}	}		Form::clearValues("update{$modul}");	msg_warning(_BERHASILHAPUS,"success");	header("location:".backendurl("$modul/view"));	exit();}else{	msg_warning(_GAGALHAPUS,"error");	header("location:".backendurl("$modul/view"));	exit();}}if($action=="sortitem"){$list=$_POST['list'];for($i=1;$i<=count($list);$i++){$idlist=cleanInput($list[$i-1],'numeric');$q=$mysql->query("UPDATE $modul set urutan=$i WHERE id='$idlist'");}exit();}?>